<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Catálogo de Produtos</title>
    <style>
        /* Seu CSS existente permanece aqui */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f9f9f9; }

        header { background: #ff7800; color: #fff; text-align: center; padding: 1rem; }

        header img {
            height: 100px;
            border-radius: 50%;
        }

        nav {
            background: #444;
            color: white;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 5%;
	    align-items: flex-start;
        }

        .categorias, .pesquisa {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.2rem;
        }

        .categorias {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow-x: auto;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            padding-bottom: 6px; /* espaço interno */
            margin-bottom: 2px; /* "empurra" a barra para fora um pouco */
        }

        .categorias::-webkit-scrollbar {
            padding-top: 50px;
            height: 6px;
        }
        .categorias::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 3px;
            padding-top: 50px;
        }

        nav button {
            white-space: nowrap;
            background: #666;
            color: white;
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        nav button:hover { background: #888; }

        .botao-carrinho {
            width: 60px;
            height: 60px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff7800;
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 2.2rem;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: space-around;
        }
        .botao-carrinho:hover {
            background: #218838;
        }
        .botao-carrinho span {
            width: 20px;
            height: 20px;
            background: red;
            color: white;
            font-size: 12px;
            border-radius: 50%;
            padding-top: 4px;
            position: absolute;
            top: 0px;
            right: -5px;
            text-align: center;
        }

        /* Animação para chamar atenção no botão do carrinho */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
            50% { transform: scale(1.2); box-shadow: 0 0 15px rgba(255,120,0,0.7); }
            100% { transform: scale(1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        }

        .botao-carrinho.animate-cart {
            animation: pulse 0.5s ease-in-out;
        }

        .pesquisa input {
            padding: 0.5rem;
            border-radius: 5px;
            border: none;
            width: 200px;
        }

        #produtos {
            width: 90%;
            margin: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            justify-content: center;
        }

        .produto {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 240px;
            padding: 1rem;
            text-align: center;
        }

        .produto img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
        }

        .produto h3 { margin: 0.5rem 0; }

        .quantidade-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .quantidade-container button {
            width: 32px;
            background: #787878 !important;
            padding: 0.3rem 0.7rem !important;
        }

        .quantidade-container span {
            margin-top: 8px;
            min-width: 20px;
            text-align: center;
            font-weight: bold;
        }

        #carrinho {
            position: fixed;
            bottom: 80px; /* Fica acima do botão flutuante */
            right: 20px;
            background: #fff;
            border: 1px solid #ccc;
            padding: 1rem;
            border-radius: 8px;
            width: 300px;
            z-index: 2;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            display: none;
        }

        #espacototalCarrinho{
            margin-top: 0.5rem;
        }

        #carrinho h3{
            border-bottom: 2px solid rgb(51, 51, 51);
            margin-bottom: 10px;
        }

        #listaCarrinho {
            max-height: 300px; /* ajuste conforme necessário */
            overflow-y: auto;
            padding-right: 6px; /* para evitar que o texto fique escondido sob a barra de rolagem */
            margin-right: -6px;
        }


        .produto button, #carrinho button, #btenviarpedido, #btcancelar, #btAdicionarAoCarrinhoComAdicionais, #btCancelarAdicionais, #btfinalizarpedido{
            font-size:16px;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: green;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #btcancelar, #btCancelarAdicionais{
            background: red;
        }

        #carrinho.ativo {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        #carrinho ul {
            list-style: none;
        }

        #carrinho li {
            margin-bottom: 0.6rem;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #carrinho li span { flex: 1; }

        #carrinho li button {
            font-size: 12px;
            background: red;
            margin-top: 0px;
            padding: 0.3rem 0.5rem;
        }

		.footer-margem{
		    padding: 1rem;
		}

		.footer-margem p{
		    margin-bottom: 6px;
		}

		#footer-store-name{
		font-size: 20px;
		}

		.footer-desenvolvido{
		background-color: #000;
		padding: 0.5rem 0.5rem;
		}

        footer {
            background: #333;
            color: white;
            text-align: center;
            margin-top: 2rem;
        }

        footer a {
            color: #fff;
            margin: 0 10px;
            text-decoration: none;
        }

        #popupPedido {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #popupPedido.ativo {
            opacity: 1;
            pointer-events: auto;
        }

        #popupPedido.ativo .popup-conteudo { transform: scale(1); }

        .popup-conteudo input, .popup-conteudo select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Estilos para o Pop-up de Adicionais */
        #popupAdicionais {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4; /* Maior que o popupPedido */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #popupAdicionais.ativo {
            opacity: 1;
            pointer-events: auto;
        }

        .popup-conteudo {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            max-height: 90vh; /* Limita a altura para rolagem */
            overflow-y: auto; /* Adiciona barra de rolagem se necessário */
            display: flex;
            flex-direction: column;
            gap: 10px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        #popupAdicionais.ativo .popup-conteudo {
            transform: scale(1);
        }

        .adicional-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .adicional-item:last-child {
            border-bottom: none;
        }

        .adicional-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            flex-grow: 1;
        }

        .adicional-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .adicional-item span {
            font-weight: bold;
        }

        /* Novo estilo para o popup de loja fechada */
        #popupLojaFechada {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999; /* Garante que fique por cima de tudo */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #popupLojaFechada.ativo {
            opacity: 1;
            pointer-events: auto;
        }

        #popupLojaFechada .popup-conteudo {
            text-align: center;
        }

        #popupLojaFechada.ativo .popup-conteudo {
            transform: scale(1);
        }

        #popupLojaFechada h3 {
            color: #d9534f;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        #popupLojaFechada p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        #popupLojaFechada button {
            background: #ff7800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        #popupLojaFechada button:hover {
            background: #e66a00;
        }
    </style>
</head>
<body>

<header>
    <div id="logo"><img id="logo-img"></div>
</header>

<nav>
    <div class="categorias" id="categorias"></div>
    <div class="pesquisa">
        <input type="text" id="pesquisaInput" placeholder="Pesquisar produtos...">
    </div>
</nav>

<div class="botao-carrinho" onclick="toggleCarrinho()">🛍️<span id="contadorCarrinho">0</span></div>

<section id="produtos"></section>

<div id="carrinho">
    <h3>Sacola</h3>
    <ul id="listaCarrinho"></ul>
    <p id="espacototalCarrinho"><strong>Total: <span id="totalCarrinho">R$ 0,00</span></strong></p>
    <button id="btfinalizarpedido" onclick="finalizarPedido()">Finalizar Pedido</button>
</div>

<div id="popupPedido">
    <div class="popup-conteudo">
        <h3>Finalizar Pedido</h3>
        <label>Nome:
            <input type="text" id="nomeCliente" />
        </label>
        <label>Endereço:
            <input type="text" id="endereco" />
        </label>
        <label>Número da Casa:
            <input type="text" id="numeroCasa" />
        </label>
        <label>Bairro:
            <select id="bairroSelect">
                <option value="">Selecione o bairro</option>
            </select>
        </label>
        <label>Forma de Pagamento:
            <select id="formaPagamento" onchange="toggleTrocoField()">
                <option value="Dinheiro">Dinheiro</option>
                <option value="Cartão de Crédito">Cartão de Crédito</option>
                <option value="Cartão de Débito">Cartão de Débito</option>
                <option value="Pix">Pix</option>
            </select>
        </label>
        <label id="labelTroco" style="display:none;">Troco para quanto?
            <input type="number" id="troco" min="0" step="0.01" placeholder="Ex: 50,00" />
        </label>

        <p id="totalPedido" style="font-weight:bold; font-size:1.2rem; margin-top:5px;">
            Total do Pedido: R$ 0,00
        </p>

        <div>
            <button id="btenviarpedido" onclick="enviarPedido()">Enviar Pedido</button>
            <button id="btcancelar" onclick="fecharPopup()">Cancelar</button>
        </div>
    </div>
</div>

<div id="popupAdicionais">
    <div class="popup-conteudo">
        <h3 id="adicionalProdutoNome">Adicionais para [Nome do Produto]</h3>
        <p id="adicionalLimitText" style="font-size: 0.9em; color: #666; margin-top: -5px; margin-bottom: 10px;"></p>
        <div id="listaAdicionais">
        </div>
        <p>
            Total do Produto com Adicionais:
            <strong id="totalProdutoComAdicionais">R$ 0,00</strong>
        </p>
        <div>
            <button id="btAdicionarAoCarrinhoComAdicionais" onclick="adicionarAoCarrinhoComAdicionais()">Adicionar à Sacola</button>
            <button id="btCancelarAdicionais" onclick="fecharPopupAdicionais()">Cancelar</button>
        </div>
    </div>
</div>

<div id="popupLojaFechada">
    <div class="popup-conteudo">
        <h3>Loja Fechada!</h3>
        <p id="mensagemHorario"></p>
        <button onclick="fecharPopupLojaFechada()">Entendi</button>
    </div>
</div>

<footer>
  <div class="footer-margem">
    <p id="footer-store-name"></p>
    <p>Siga-nos:
        <a id="instagram-link" href="#" target="_blank">Instagram</a> |
        <a id="facebook-link" href="#" target="_blank">Facebook</a> |
        <a id="whatsapp-link" href="#" target="_blank">WhatsApp</a>
    </p>
    <p id="footer-address"></p>
    <p id="footer-contact-phones"></p>
  </div>
  <div class="footer-desenvolvido">
    <p>Desenvolvido por: <a href="#" target="_blank">Emerson Marks</a></p>
  </div>
</footer>

<script>
    const SHEET_URL_PRODUTOS = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=0";
    const SHEET_URL_BAIRROS = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=498087514";
    const SHEET_URL_ADICIONAIS = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=290055706";
    const SHEET_URL_CONFIGURACOES = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=1791928589";
    const SHEET_URL_CATEGORIAS_ORDEM = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=1852665090";
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwworIpjpCkrd0tiuWscrukXjmTEI7n_gtnmy-ptvaqpCRDrbBXbFzu505f1Wb2dMZWYg/exec";

    let produtos = [];
    let bairrosEntrega = {};
    let adicionais = [];
    let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    let horarioFuncionamento = {}; // Para armazenar os horários de funcionamento
    let isLojaAbertaStatus = false; // Nova variável para rastrear o status da loja
    let categoriasOrdem = []; // Para armazenar a ordem das categorias
    let whatsappOrderNumber = ""; // Will store the WhatsApp number for orders

    let produtoSelecionadoParaAdicionais = null;
    let adicionaisSelecionadosTemp = [];

    const diasDaSemana = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];

    document.addEventListener("DOMContentLoaded", async () => {
        // Carrega as configurações (logo, redes sociais, endereço, NOME DA LOJA, TELEFONES)
        await fetchConfiguracoes();

        // Busca todas as outras planilhas em paralelo
        await Promise.all([
            fetchCategoriasOrdem(), // Retornar uma Promise diretamente
            fetch(SHEET_URL_PRODUTOS)
                .then(res => res.text())
                .then(text => JSON.parse(text.substr(47).slice(0, -2)))
                .then(json => {
                    const rows = json.table.rows;
                    produtos = rows
                        .filter(row => row.c[0]?.v?.toLowerCase() === "sim")
                        .map(row => {
                            const c = row.c;
                            return {
                                nome: c[1]?.v,
                                categoria: c[2]?.v,
                                descricao: c[3]?.v,
                                preco: parseFloat(c[4]?.v),
                                tipoAdicional: c[5]?.v,
                                imagem: c[7]?.v,
                                maxAdicionais: parseInt(c[6]?.v) || 999
                            };
                        });
                }),
            fetch(SHEET_URL_BAIRROS)
                .then(res => res.text())
                .then(text => JSON.parse(text.substr(47).slice(0, -2)))
                .then(json => {
                    const rows = json.table.rows;
                    bairrosEntrega = {};
                    const bairroSelect = document.getElementById("bairroSelect");
                    bairroSelect.innerHTML = '<option value="">Selecione o bairro</option>';

                    rows.forEach(row => {
                        const c = row.c;
                        const nomeBairro = c[0]?.v;
                        const valorEntrega = parseFloat(c[1]?.v) || 0;
                        bairrosEntrega[nomeBairro] = valorEntrega;

                        const option = document.createElement("option");
                        option.value = nomeBairro;
                        option.textContent = `${nomeBairro} - R$ ${valorEntrega.toFixed(2).replace('.', ',')}`;
                        bairroSelect.appendChild(option);
                    });
                }),
            fetch(SHEET_URL_ADICIONAIS)
                .then(res => res.text())
                .then(text => JSON.parse(text.substr(47).slice(0, -2)))
                .then(json => {
                    const rows = json.table.rows;
                    adicionais = rows.map(row => {
                        const c = row.c;
                        return {
                            tipo: c[0]?.v,
                            nome: c[1]?.v,
                            preco: parseFloat(c[2]?.v) || 0
                        };
                    });
                })
        ]);

        // Após todos os dados estarem carregados, renderize e configure o restante
        checkHorarioFuncionamento();
        renderCategorias();
        renderProdutos(produtos);
        renderCarrinho();

        document.getElementById("pesquisaInput").addEventListener("input", e => {
            const termo = e.target.value.toLowerCase();
            const filtrados = produtos.filter(p => p.nome.toLowerCase().includes(termo));
            renderProdutos(filtrados);
        });

        document.getElementById("bairroSelect").addEventListener("change", () => {
            mostrarValorEntrega(document.getElementById("bairroSelect").value);
            atualizarTotalPedido();
        });

        document.getElementById("formaPagamento").addEventListener("change", toggleTrocoField);
    });

    async function fetchConfiguracoes() {
        try {
            const response = await fetch(SHEET_URL_CONFIGURACOES);
            const text = await response.text();
            const json = JSON.parse(text.substr(47).slice(0, -2));
            const rows = json.table.rows;

            if (rows.length > 0) {
                const configRow = rows[0].c;

                // Nome da Loja (Coluna A, índice 0)
                const storeName = configRow[0]?.v;
                if (storeName) {
                    document.getElementById("footer-store-name").textContent = storeName;
                }

                // Logo (Coluna B, índice 1)
                const logoUrl = configRow[1]?.v;
                if (logoUrl) {
                    document.getElementById("logo-img").src = logoUrl;
					document.getElementById("logo-img").alt = "Logomarca";

                }

                // Social Media Links (Colunas C, D, E, índices 2, 3, 4)
                const instagramLink = configRow[2]?.v;
                const facebookLink = configRow[3]?.v;
                const whatsappLink = configRow[4]?.v;

                if (instagramLink) {
                    document.getElementById("instagram-link").href = instagramLink;
                }
                if (facebookLink) {
                    document.getElementById("facebook-link").href = facebookLink;
                }
                if (whatsappLink) {
                    document.getElementById("whatsapp-link").href = 'https://wa.me/' + whatsappLink;
                    whatsappOrderNumber = whatsappLink; // Assign to global variable for orders
                }

                // Address (Coluna F, índice 5)
                const footerAddress = configRow[5]?.v;
                if (footerAddress) {
                    document.getElementById("footer-address").textContent = footerAddress;
                }

                // Telefones para Contato (NOVA Coluna G, índice 6)
                const contactPhones = configRow[6]?.v;
                if (contactPhones) {
                    document.getElementById("footer-contact-phones").textContent = contactPhones;
                }

                // Operating Hours (Agora começando da Coluna H, índice 7)
                horarioFuncionamento = {};
                rows.forEach(row => {
                    const c = row.c;
                    if (c[7]?.v) { // Dia da Semana é c[7]
                        horarioFuncionamento[c[7].v] = {
                            abertura: c[8]?.f, // Abertura é c[8]
                            almocoInicio: c[9]?.f, // Almoco Inicio é c[9]
                            almocoFim: c[10]?.f, // Almoco Fim é c[10]
                            fechamento: c[11]?.f // Fechamento é c[11]
                        };
                    }
                });
            }

        } catch (error) {
            horarioFuncionamento = null;
        }
    }

    async function fetchCategoriasOrdem() {
        try {
            const response = await fetch(SHEET_URL_CATEGORIAS_ORDEM);
            const text = await response.text();
            const json = JSON.parse(text.substr(47).slice(0, -2));
            const rows = json.table.rows;

            categoriasOrdem = rows.map(row => {
                const c = row.c;
                return {
                    posicao: parseInt(c[0]?.v),
                    nome: c[1]?.v,
                    descricao: c[2]?.v
                };
            }).sort((a, b) => a.posicao - b.posicao);

        } catch (error) {
            console.error("Erro ao carregar a ordem das categorias:", error);
            categoriasOrdem = []; // Fallback to empty array
        }
    }

    function checkHorarioFuncionamento() {
        if (!horarioFuncionamento) {
            exibirPopupLojaFechada("Não foi possível carregar os horários de funcionamento.");
            isLojaAbertaStatus = false;
            updateFinalizarPedidoButton();
            return;
        }

        const now = new Date();
        const diaAtual = diasDaSemana[now.getDay()]; // 0 = Domingo, 1 = Segunda, etc.
        const horaAtual = now.getHours() * 60 + now.getMinutes(); // Minutos desde a meia-noite

        const configDia = horarioFuncionamento[diaAtual];

        if (!configDia || !configDia.abertura || !configDia.fechamento) {
            exibirPopupLojaFechada(`Não funcionamos na ${diaAtual}.`);
            isLojaAbertaStatus = false;
            updateFinalizarPedidoButton();
            return;
        }

        const parseTime = (timeStr) => {
            if (!timeStr) return -1; // -1 para indicar que não há horário definido
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        };

        const abertura = parseTime(configDia.abertura);
        const fechamento = parseTime(configDia.fechamento);
        const almocoInicio = parseTime(configDia.almocoInicio);
        const almocoFim = parseTime(configDia.almocoFim);

        let isLojaAbertaLocal = false;
        let mensagem = "";

        if (abertura === -1 || fechamento === -1) {
            isLojaAbertaLocal = false;
            mensagem = `Os horários de abertura ou fechamento para ${diaAtual} não estão configurados corretamente.`;
        } else if (horaAtual >= abertura && horaAtual < fechamento) {
            // Está dentro do horário de funcionamento geral
            if (almocoInicio !== -1 && almocoFim !== -1 && horaAtual >= almocoInicio && horaAtual < almocoFim) {
                // Está dentro do horário de almoço
                isLojaAbertaLocal = false;
                mensagem = `Estamos em horário de almoço. Abriremos novamente às ${configDia.almocoFim}.`;
            } else {
                isLojaAbertaLocal = true;
                mensagem = `Estamos abertos até as ${configDia.fechamento}! Faça seu pedido.`;
            }
        } else {
            // Fora do horário de funcionamento geral
            isLojaAbertaLocal = false;
            mensagem = `No momento estamos fechados. Nosso horário de funcionamento para ${diaAtual} é das ${configDia.abertura} às ${configDia.fechamento}.`;
            if (almocoInicio !== -1 && almocoFim !== -1) {
                mensagem += ` Com intervalo das ${configDia.almocoInicio} às ${configDia.almocoFim}.`;
            }
        }

        isLojaAbertaStatus = isLojaAbertaLocal; // Atualiza o status global

        if (!isLojaAbertaStatus) {
            exibirPopupLojaFechada(mensagem);
        } else {
           // Apenas loga se estiver aberto, não exibe popup
        }
        updateFinalizarPedidoButton();
    }

    function exibirPopupLojaFechada(mensagem) {
        document.getElementById("mensagemHorario").textContent = mensagem;
        document.getElementById("popupLojaFechada").classList.add("ativo");
    }

    function fecharPopupLojaFechada() {
        document.getElementById("popupLojaFechada").classList.remove("ativo");
    }

    function updateFinalizarPedidoButton() {
        const finalizarBtn = document.getElementById("btfinalizarpedido");
        if (isLojaAbertaStatus) {
            finalizarBtn.disabled = false;
            finalizarBtn.style.backgroundColor = "green";
            finalizarBtn.textContent = "Finalizar Pedido";
        } else {
            finalizarBtn.disabled = true;
            finalizarBtn.style.backgroundColor = "#ccc";
            finalizarBtn.textContent = "Loja Fechada";
        }
    }


    function renderCategorias() {
        const catContainer = document.getElementById("categorias");
        catContainer.innerHTML = "";

        const btnTodas = document.createElement("button");
        btnTodas.textContent = "Todas";
        btnTodas.onclick = () => renderProdutos(produtos);
        catContainer.appendChild(btnTodas);

        // Get unique categories from the *currently available products*
        const categoriasComProdutos = [...new Set(produtos.map(p => p.categoria))];

        // Filter and sort categories based on `categoriasOrdem`
        let categoriasParaRenderizar = categoriasOrdem
            .filter(catOrder => categoriasComProdutos.includes(catOrder.nome))
            .map(catOrder => catOrder.nome);

        // Add any categories from products that are not in the fetched order
        // and ensure they are sorted alphabetically
        categoriasComProdutos.forEach(cat => {
            if (!categoriasParaRenderizar.includes(cat)) {
                categoriasParaRenderizar.push(cat);
            }
        });

        // Re-sort to maintain the order from categoriasOrdem for those present,
        // and alphabetical for others.
        categoriasParaRenderizar.sort((a, b) => {
            const indexA = categoriasOrdem.findIndex(c => c.nome === a);
            const indexB = categoriasOrdem.findIndex(c => c.nome === b);

            if (indexA === -1 && indexB === -1) {
                return a.localeCompare(b); // Both not in custom order, sort alphabetically
            }
            if (indexA === -1) {
                return 1; // A is not in custom order, B is, so B comes after
            }
            if (indexB === -1) {
                return -1; // B is not in custom order, A is, so A comes after
            }
            return indexA - indexB; // Both in custom order, sort by custom order
        });


        categoriasParaRenderizar.forEach(cat => {
            const btn = document.createElement("button");
            btn.textContent = cat;
            btn.onclick = () => {
                const filtrados = produtos.filter(p => p.categoria === cat);
                renderProdutos(filtrados);
            };
            catContainer.appendChild(btn);
        });
    }

    function renderProdutos(lista) {
        const container = document.getElementById("produtos");
        container.innerHTML = "";

        const categoriasMap = {};
        lista.forEach(p => {
            if (!categoriasMap[p.categoria]) {
                categoriasMap[p.categoria] = [];
            }
            categoriasMap[p.categoria].push(p);
        });

        // Use the fetched category order to sort the display
        const categoriasOrdenadas = categoriasOrdem
            .filter(cat => categoriasMap[cat.nome]) // Only include categories that have products
            .map(cat => cat.nome);

        // Add any categories from products that are not in the fetched order (fallback)
        const existingProductCategories = [...new Set(lista.map(p => p.categoria))];
        existingProductCategories.forEach(cat => {
            if (!categoriasOrdenadas.includes(cat)) {
                categoriasOrdenadas.push(cat);
            }
        });
        // Sort any newly added categories alphabetically if they weren't explicitly ordered
        categoriasOrdenadas.sort((a, b) => {
            const indexA = categoriasOrdem.findIndex(c => c.nome === a);
            const indexB = categoriasOrdem.findIndex(c => c.nome === b);

            if (indexA === -1 && indexB === -1) {
                return a.localeCompare(b); // Both not in custom order, sort alphabetically
            }
            if (indexA === -1) {
                return 1; // A is not in custom order, B is, so B comes first
            }
            if (indexB === -1) {
                return -1; // B is not in custom order, A is, so A comes first
            }
            return indexA - indexB; // Both in custom order, sort by custom order
        });


        categoriasOrdenadas.forEach(categoria => {
            const tituloCat = document.createElement("h2");
            tituloCat.textContent = categoria;
            tituloCat.style.width = "100%";
            tituloCat.style.borderBottom = "2px solid #333";
            tituloCat.style.margin = "1rem 0 0.5rem 0";
            container.appendChild(tituloCat);

            // Find the description for the current category
            const categoriaInfo = categoriasOrdem.find(c => c.nome === categoria);
            if (categoriaInfo && categoriaInfo.descricao) {
                const descricaoP = document.createElement("p");
                descricaoP.textContent = categoriaInfo.descricao;
                descricaoP.style.width = "100%";
                descricaoP.style.marginTop = "-15px";
                descricaoP.style.fontStyle = "italic";
                descricaoP.style.color = "#555";
                container.appendChild(descricaoP);
            }

            categoriasMap[categoria].sort((a, b) => a.nome.localeCompare(b.nome));

            categoriasMap[categoria].forEach((p, index) => {
                const id = `${categoria}_${index}`.replace(/\s+/g, "_");
                const card = document.createElement("div");
                card.className = "produto";
                card.innerHTML =         `<img src="${p.imagem}" alt="${p.nome}" loading="lazy">
                    <h3>${p.nome}</h3>
                    <p>${p.descricao}</p>
                    <p><strong>${p.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></p>
                    <div class="quantidade-container">
                        <button onclick="alterarQuantidade('subtrair', '${id}')">-</button>
                        <span id="qtd_${id}">1</span>
                        <button onclick="alterarQuantidade('adicionar', '${id}')">+</button>
                    </div>
                    <button onclick='prepararParaAdicionarCarrinho(${JSON.stringify(p).replace(/'/g, "\\'")}, "${id}")'>Adicionar</button>`;
                container.appendChild(card);
            });
        });
    }

    function alterarQuantidade(acao, id) {
        const span = document.getElementById(`qtd_${id}`);
        let qtdAtual = parseInt(span.textContent);
        if (acao === 'adicionar') {
            qtdAtual += 1;
        } else if (acao === 'subtrair' && qtdAtual > 1) {
            qtdAtual -= 1;
        }
        span.textContent = qtdAtual;
    }

    function prepararParaAdicionarCarrinho(produto, id) {
        const qtd = parseInt(document.getElementById(`qtd_${id}`).textContent);
        if (qtd <= 0 || isNaN(qtd)) {
            alert("Quantidade inválida!");
            return;
        }

        produtoSelecionadoParaAdicionais = { ...produto, quantidade: qtd, idOriginal: id };
        adicionaisSelecionadosTemp = [];

        if (produto.tipoAdicional && produto.tipoAdicional !== "Não") {
            abrirPopupAdicionais(produto);
        } else {
            adicionarAoCarrinhoFinal({
                ...produtoSelecionadoParaAdicionais,
                adicionais: []
            });
        }
    }

    function abrirPopupAdicionais(produto) {
        document.getElementById("adicionalProdutoNome").textContent = `Adicionais para ${produto.nome}`;
        const adicionalLimitText = document.getElementById("adicionalLimitText");
        if (produto.maxAdicionais && produto.maxAdicionais !== 999) {
            adicionalLimitText.textContent = `Selecione até ${produto.maxAdicionais} adicional(is).`;
        } else {
            adicionalLimitText.textContent = "";
        }


        const listaAdicionaisDiv = document.getElementById("listaAdicionais");
        listaAdicionaisDiv.innerHTML = "";

        const adicionaisFiltrados = adicionais.filter(a => a.tipo === produto.tipoAdicional);

        if (adicionaisFiltrados.length === 0) {
            adicionarAoCarrinhoFinal({
                ...produtoSelecionadoParaAdicionais,
                adicionais: []
            });
            return;
        }

        adicionaisFiltrados.forEach(adicional => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "adicional-item";
            itemDiv.innerHTML =         `<label>
                <input type="checkbox" data-nome="${adicional.nome}" data-preco="${adicional.preco.toFixed(2)}">
                ${adicional.nome}
            </label>
            <span>+ ${adicional.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>`;
            listaAdicionaisDiv.appendChild(itemDiv);
        });

        listaAdicionaisDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', actualizarTotalProdutoComAdicionais);
        });

        actualizarTotalProdutoComAdicionais();
        document.getElementById("popupAdicionais").classList.add("ativo");
    }

    function fecharPopupAdicionais() {
        document.getElementById("popupAdicionais").classList.remove("ativo");
        produtoSelecionadoParaAdicionais = null;
        adicionaisSelecionadosTemp = [];
    }

    function actualizarTotalProdutoComAdicionais() {
        let totalProduto = produtoSelecionadoParaAdicionais.preco;
        adicionaisSelecionadosTemp = [];

        const checkboxes = document.querySelectorAll('#listaAdicionais input[type="checkbox"]');
        let selectedCount = 0;

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedCount++;
            }
        });

        const maxAllowed = produtoSelecionadoParaAdicionais.maxAdicionais;

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const nome = checkbox.dataset.nome;
                const preco = parseFloat(checkbox.dataset.preco);
                totalProduto += preco;
                adicionaisSelecionadosTemp.push({ nome: nome, preco: preco });
            } else if (selectedCount >= maxAllowed && maxAllowed !== 999) {
                checkbox.disabled = true;
            } else {
                checkbox.disabled = false;
            }
        });

        // Update the limit message
        const adicionalLimitText = document.getElementById("adicionalLimitText");
        if (maxAllowed !== 999) {
            adicionalLimitText.textContent = `Selecione até ${maxAllowed} adicional(is). Selecionados: ${selectedCount}`;
            if (selectedCount >= maxAllowed) {
                adicionalLimitText.style.color = "red";
            } else {
                adicionalLimitText.style.color = "#666";
            }
        }

        const totalComAdicionais = totalProduto;
        document.getElementById("totalProdutoComAdicionais").textContent = totalComAdicionais.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function adicionarAoCarrinhoComAdicionais() {
        const maxAllowed = produtoSelecionadoParaAdicionais.maxAdicionais;
        if (adicionaisSelecionadosTemp.length > maxAllowed && maxAllowed !== 999) {
            alert(`Você pode selecionar no máximo ${maxAllowed} adicional(is) para este produto.`);
            return;
        }

        const produtoComAdicionais = {
            ...produtoSelecionadoParaAdicionais,
            quantidade: produtoSelecionadoParaAdicionais.quantidade,
            adicionais: adicionaisSelecionadosTemp
        };
        adicionarAoCarrinhoFinal(produtoComAdicionais);
        fecharPopupAdicionais();
    }

    function adicionarAoCarrinhoFinal(item) {
        const itemExistenteIndex = carrinho.findIndex(carrinhoItem =>
            carrinhoItem.nome === item.nome &&
            JSON.stringify(carrinhoItem.adicionais) === JSON.stringify(item.adicionais)
        );

        if (itemExistenteIndex > -1) {
            carrinho[itemExistenteIndex].quantidade += item.quantidade;
        } else {
            carrinho.push(item);
        }

        localStorage.setItem("carrinho", JSON.stringify(carrinho));
        renderCarrinho();

        const idProdutoAtual = produtoSelecionadoParaAdicionais.idOriginal;
        if (idProdutoAtual) {
            document.getElementById(`qtd_${idProdutoAtual}`).textContent = 1;
        }

        const botaoCarrinho = document.querySelector(".botao-carrinho");
        botaoCarrinho.classList.add("animate-cart");
        setTimeout(() => {
            botaoCarrinho.classList.remove("animate-cart");
        }, 500);
    }

    function renderCarrinho() {
        const lista = document.getElementById("listaCarrinho");
        const contador = document.getElementById("contadorCarrinho");
        const totalSpan = document.getElementById("totalCarrinho");
        lista.innerHTML = "";
        let totalItens = 0;
        let valorTotal = 0;

        carrinho.forEach((p, i) => {
            totalItens += p.quantidade;
            let precoItem = p.preco;
            let descAdicionais = "";

            if (p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(ad => {
                    precoItem += ad.preco;
                    descAdicionais += `\n        +${ad.nome} (${(ad.preco * p.quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })})`;
                });
            }

            valorTotal += precoItem * p.quantidade;

            const li = document.createElement("li");
            li.innerHTML =         `<span>
                <strong>${p.quantidade}x ${p.nome} - ${(p.preco * p.quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong><br>
                ${descAdicionais ? `<small>${descAdicionais}</small>` : ''}
            </span>
            <button onclick="removerItem(${i}, event)">X</button>`;
            lista.appendChild(li);
        });

        contador.textContent = totalItens;
        totalSpan.textContent = valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        atualizarTotalPedido();
    }

    function removerItem(index, event) {
        event.stopPropagation();
        carrinho.splice(index, 1);
        localStorage.setItem("carrinho", JSON.stringify(carrinho));
        renderCarrinho();
    }

    function toggleCarrinho() {
        document.getElementById("carrinho").classList.toggle("ativo");
    }

    document.addEventListener("click", function (event) {
        const carrinhoBox = document.getElementById("carrinho");
        const botaoCarrinho = document.querySelector(".botao-carrinho");
        const popupPedido = document.getElementById("popupPedido");
        const popupAdicionais = document.getElementById("popupAdicionais");
        const popupLojaFechada = document.getElementById("popupLojaFechada");

        if (
            carrinhoBox.classList.contains("ativo") &&
            !carrinhoBox.contains(event.target) &&
            !botaoCarrinho.contains(event.target) &&
            !popupPedido.contains(event.target) &&
            !popupAdicionais.contains(event.target) &&
            !popupLojaFechada.contains(event.target)
        ) {
            carrinhoBox.classList.remove("ativo");
        }
    });

    function finalizarPedido() {
        // Verificar o horário antes de abrir o popup de pedido
        checkHorarioFuncionamento(); // Re-checa e atualiza isLojaAbertaStatus e exibe popup se necessário

        if (!isLojaAbertaStatus) {
            return; // Se a loja estiver fechada, a função checkHorarioFuncionamento já exibiu o popup
        }

        if (carrinho.length === 0) {
            alert("O carrinho está vazio!");
            return;
        }

        document.getElementById("carrinho").classList.remove("ativo");

        document.getElementById("nomeCliente").value = localStorage.getItem("nomeCliente") || "";
        document.getElementById("endereco").value = localStorage.getItem("endereco") || "";
        document.getElementById("numeroCasa").value = localStorage.getItem("numeroCasa") || "";
        document.getElementById("bairroSelect").value = localStorage.getItem("bairro") || "";
        document.getElementById("formaPagamento").value = localStorage.getItem("formaPagamento") || "Dinheiro";

        toggleTrocoField();

        atualizarTotalPedido();

        document.getElementById("popupPedido").classList.add("ativo");
    }

    function fecharPopup() {
        document.getElementById("popupPedido").classList.remove("ativo");
    }

    function mostrarValorEntrega(bairro) {
        // Pode ser usado para algum feedback visual (opcional)
    }

    function atualizarTotalPedido() {
        const totalProdutosCalculado = carrinho.reduce((acc, p) => {
            let precoComAdicionais = p.preco;
            if (p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(ad => precoComAdicionais += ad.preco);
            }
            return acc + precoComAdicionais * p.quantidade;
        }, 0);

        const bairro = document.getElementById("bairroSelect").value;
        const taxaEntrega = bairrosEntrega[bairro] || 0;
        const total = totalProdutosCalculado + taxaEntrega;

        const totalPedidoSpan = document.getElementById("totalPedido");
        totalPedidoSpan.textContent = `Total do Pedido: R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    function toggleTrocoField() {
        const formaPagamento = document.getElementById("formaPagamento").value;
        const labelTroco = document.getElementById("labelTroco");

        if (formaPagamento === "Dinheiro") {
            labelTroco.style.display = "block";
        } else {
            labelTroco.style.display = "none";
            document.getElementById("troco").value = "";
        }
    }

    async function enviarPedido() {
        // Verificar o horário antes de enviar o pedido
        checkHorarioFuncionamento(); // Re-checa e atualiza isLojaAbertaStatus e exibe popup se necessário

        if (!isLojaAbertaStatus) {
            return; // Se a loja estiver fechada, a função checkHorarioFuncionamento já exibiu o popup
        }

        const btnEnviarPedido = document.getElementById("btenviarpedido");

        // Immediately disable the button to prevent multiple clicks
        btnEnviarPedido.disabled = true;

        const nome = document.getElementById("nomeCliente").value.trim();
        const endereco = document.getElementById("endereco").value.trim();
        const numeroCasa = document.getElementById("numeroCasa").value.trim();
        const bairro = document.getElementById("bairroSelect").value;
        const formaPagamento = document.getElementById("formaPagamento").value;
        const troco = document.getElementById("troco").value.trim();

        // Basic client-side validation
        if (!nome || !endereco || !numeroCasa || !bairro || !formaPagamento) {
            alert("Por favor, preencha todos os campos.");
            btnEnviarPedido.disabled = false; // Re-enable if validation fails
            return;
        }

        let totalPedidoFinal = 0;
        const totalProdutosComAdicionais = carrinho.reduce((acc, p) => {
            let precoComAdicionais = p.preco;
            if (p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(ad => precoComAdicionais += ad.preco);
            }
            return acc + precoComAdicionais * p.quantidade;
        }, 0);

        const taxaEntrega = bairrosEntrega[bairro] || 0;
        totalPedidoFinal = totalProdutosComAdicionais + taxaEntrega;

        if (formaPagamento === "Dinheiro") {
            const trocoValor = parseFloat(troco.replace(',', '.'));

            if (!troco || isNaN(trocoValor)) {
                alert("Por favor, informe um valor válido para o troco.");
                btnEnviarPedido.disabled = false; // Re-enable if validation fails
                return;
            }

            if (trocoValor < totalPedidoFinal) {
                alert(`O valor para troco deve ser maior ou igual ao total da compra (${totalPedidoFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}).`);
                btnEnviarPedido.disabled = false; // Re-enable if validation fails
                return;
            }
        }

        localStorage.setItem("nomeCliente", nome);
        localStorage.setItem("endereco", endereco);
        localStorage.setItem("numeroCasa", numeroCasa);
        localStorage.setItem("bairro", bairro);
        localStorage.setItem("formaPagamento", formaPagamento);
        if (formaPagamento === "Dinheiro") {
            localStorage.setItem("troco", troco);
        } else {
            localStorage.removeItem("troco");
        }

        let detalhesPedidoString = "";
        carrinho.forEach(p => {
            let precoUnitarioComAdicionais = p.preco;
            let adicionaisTextoDetalhe = "";
            if (p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(ad => {
                    precoUnitarioComAdicionais += ad.preco;
                    adicionaisTextoDetalhe += ` + ${ad.nome} (R$${(ad.preco * p.quantidade).toFixed(2).replace('.', ',')})`;
                });
            }
            detalhesPedidoString += `${p.quantidade}x ${p.nome} (R$${(p.preco * p.quantidade).toFixed(2).replace('.', ',')}) ${adicionaisTextoDetalhe}\n`;
			});
        detalhesPedidoString = detalhesPedidoString.trim();

        try {
            // Send to Google Apps Script (to save to the spreadsheet)
            await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nomeCliente: nome,
                    endereco: endereco,
                    numeroCasa: numeroCasa,
                    bairro: bairro,
                    formaPagamento: formaPagamento,
                    troco: formaPagamento === "Dinheiro" ? parseFloat(troco) : 0,
                    totalPedido: totalPedidoFinal,
                    detalhesPedido: detalhesPedidoString
                }),
            });


            // Send to WhatsApp (existing code)
            let msg = `🛒 *Novo Pedido*\n`;
            msg += `👤 *Nome:* ${nome}\n`;
            msg += `📦 *Itens:*\n`;

            carrinho.forEach(p => {
                let precoUnitarioComAdicionais = p.preco;
                let adicionaisTexto = "";
                if (p.adicionais && p.adicionais.length > 0) {
                    p.adicionais.forEach(ad => {
                        precoUnitarioComAdicionais += ad.preco;
                        adicionaisTexto += `\n        + ${ad.nome} - ${(ad.preco * p.quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    });
                }
                msg += `🔹 ${p.quantidade}x ${p.nome} - ${(p.preco * p.quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}${adicionaisTexto}\n`;
            });

            msg += `\n💰 *Total dos Produtos:* ${totalProdutosComAdicionais.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}\n`;
            msg += `🚚 *Taxa de Entrega:* ${taxaEntrega.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}\n`;
            msg += `💰 *Total:* ${totalPedidoFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}\n`;
            if (formaPagamento === "Dinheiro") {
                msg += `💵 *Pagamento:* ${formaPagamento} (Troco para R$ ${parseFloat(troco).toFixed(2).replace('.', ',')})\n\n`;
            } else {
                msg += `💳 *Pagamento:* ${formaPagamento}\n\n`;
            }

            msg += `🏠 *Endereço:* ${endereco}, Nº ${numeroCasa}, Bairro ${bairro}\n`;
            msg += `✅ *Aguardo confirmação!*`;

            const url = `https://wa.me/${whatsappOrderNumber}?text=${encodeURIComponent(msg)}`; // Using whatsappOrderNumber
            window.open(url, "_blank");

            carrinho = [];
            localStorage.removeItem("carrinho");
            renderCarrinho();
            fecharPopup();

        } catch (error) {
            alert("Erro ao finalizar o pedido. Por favor, tente novamente.");
        } finally {
            // Re-enable the button regardless of success or failure
            btnEnviarPedido.disabled = false;
        }
    }
</script>

</body>
</html>
