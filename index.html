<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Cat√°logo de Produtos</title>
    <style>

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f9f9f9; }

        header { background: #ff7800; color: #fff; text-align: center; padding: 1rem; }

        header img {
            height: 100px;
            border-radius: 50%;
        }

        nav {
            background: #444;
            color: white;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 5%;
	    align-items: flex-start;
        }

        .categorias, .pesquisa {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.2rem;
        }

        .categorias {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow-x: auto;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            padding-bottom: 6px; /* espa√ßo interno */
            margin-bottom: 2px; /* "empurra" a barra para fora um pouco */
        }

        .categorias::-webkit-scrollbar {
            padding-top: 50px;
            height: 6px;
        }
        .categorias::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 3px;
            padding-top: 50px;
        }

        nav button {
			font-size: 16px;
            white-space: nowrap;
            background: #666;
            color: white;
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        nav button:hover { background: #888; }

        .botao-carrinho {
            width: 60px;
            height: 60px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff7800;
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 2.2rem;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: space-around;
        }
        .botao-carrinho:hover {
            background: #218838;
        }
        .botao-carrinho span {
            width: 20px;
            height: 20px;
            background: red;
            color: white;
            font-size: 12px;
            border-radius: 50%;
            padding-top: 4px;
            position: absolute;
            top: 0px;
            right: -5px;
            text-align: center;
        }

        /* Anima√ß√£o para chamar aten√ß√£o no bot√£o do carrinho */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
            50% { transform: scale(1.2); box-shadow: 0 0 15px rgba(255,120,0,0.7); }
            100% { transform: scale(1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        }

        .botao-carrinho.animate-cart {
            animation: pulse 0.5s ease-in-out;
        }

        .pesquisa input {
            padding: 0.5rem;
            border-radius: 5px;
            border: none;
            width: 200px;
        }

        #produtos {
            width: 90%;
            margin: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            justify-content: center;
        }

        .produto {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 240px;
            padding: 1rem;
            text-align: center;
        }

        .produto img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
        }

        .produto h3 { margin: 0.5rem 0; }

        .quantidade-container {
			float: left;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
			margin-top: 3px;
        }

        .quantidade-container button {
            width: 32px;
            background: #787878 !important;
            padding: 0.3rem 0.7rem !important;
        }

        .quantidade-container span {
            margin-top: 8px;
            min-width: 20px;
            text-align: center;
            font-weight: bold;
        }
		
		.valor{
			margin-top: 0.5rem;
			font-size:18px;
		}

        #carrinho {
            position: fixed;
            bottom: 80px; /* Fica acima do bot√£o flutuante */
            right: 20px;
            background: #fff;
            border: 1px solid #ccc;
            padding: 1rem;
            border-radius: 8px;
            width: 300px;
            z-index: 2;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            display: none;
        }

        #espacototalCarrinho{
            margin-top: 0.5rem;
        }

        #carrinho h3{
            border-bottom: 2px solid rgb(51, 51, 51);
            margin-bottom: 10px;
        }

        #listaCarrinho {
            max-height: 300px; /* ajuste conforme necess√°rio */
            overflow-y: auto;
            padding-right: 6px; /* para evitar que o texto fique escondido sob a barra de rolagem */
            margin-right: -6px;
        }


        .produto button, #carrinho button, #btenviarpedido, #btcancelar, #btAdicionarAoCarrinhoComAdicionais, #btCancelarAdicionais, #btfinalizarpedido, #btVoltar{
            font-size:16px;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: green;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
		
		#btVoltar{
			width:160px;
			align-self: center;
		}
		
		.produto button{
			float:right;
		
		}

        #btcancelar, #btCancelarAdicionais{
            background: red;
        }

        #carrinho.ativo {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        #carrinho ul {
            list-style: none;
        }

        #carrinho li {
            margin-bottom: 0.6rem;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #carrinho li span { flex: 1; }

        #carrinho li button {
            font-size: 12px;
            background: red;
            margin-top: 0px;
            padding: 0.3rem 0.5rem;
        }

		.footer-margem{
		    padding: 1rem;
		}

		.footer-margem p{
		    margin-bottom: 6px;
		}

		#footer-store-name{
		font-size: 20px;
		}

		.footer-desenvolvido{
		background-color: #000;
		padding: 0.5rem 0.5rem;
		}

        footer {
            background: #333;
            color: white;
            text-align: center;
            margin-top: 2rem;
        }

        footer a {
            color: #fff;
            margin: 0 10px;
            text-decoration: none;
        }

        #popupPedido {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #popupPedido.ativo {
            opacity: 1;
            pointer-events: auto;
        }

        #popupPedido.ativo .popup-conteudo { transform: scale(1); }

        .popup-conteudo input, .popup-conteudo select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Estilos para o Pop-up de Adicionais e Sabores */
        #popupAdicionais {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4; /* Maior que o popupPedido */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #popupAdicionais.ativo {
            opacity: 1;
            pointer-events: auto;
        }

        .popup-conteudo {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 94%;
            max-width: 500px;
            max-height: 94%; /* Limita a altura para rolagem */
            overflow-y: auto; /* Adiciona barra de rolagem se necess√°rio */
            display: flex;
            flex-direction: column;
            gap: 10px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .adicionais-group {
            margin-bottom: 15px;
            padding: 10px; /* Adicionado padding para a borda */
            border: 1px solid #ccc; /* Adicionada borda */
            border-radius: 8px; /* Opcional: arredondar a borda */
        }
		
		.adicionais-group .info-limit {
			margin-bottom: 5px;
			font-size: 1rem;
		}
		
		.adicionais-group h4 {
			color: #ff7800; /* Cor do t√≠tulo alterada */
			font-size: 1.2rem;
		}


        #popupAdicionais.ativo .popup-conteudo {
            transform: scale(1);
        }

        .adicional-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .adicional-item:last-child {
            border-bottom: none;
        }

        .adicional-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            flex-grow: 1;
        }

        .adicional-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .adicional-item span {
            font-weight: bold;
        }
        
		.card-tipo {
		flex: 1;
		min-width: 100px;
		padding: 10px;
		background-color: #eee;
		border-radius: 8px;
		border: 2px solid transparent;
		text-align: center;
		cursor: pointer;
		transition: 0.3s;
		}
		.card-tipo.selecionado {
		border-color: #ff7800;
		background-color: #fff3e6;
		font-weight: bold;
		}
		

        /* Novo estilo para o popup de loja fechada */
        #popupLojaFechada {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999; /* Garante que fique por cima de tudo */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #popupLojaFechada.ativo {
            opacity: 1;
            pointer-events: auto;
        }

        #popupLojaFechada .popup-conteudo {
            text-align: center;
        }

        #popupLojaFechada.ativo .popup-conteudo {
            transform: scale(1);
        }

        #popupLojaFechada h3 {
            color: #d9534f;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        #popupLojaFechada p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        #popupLojaFechada button {
            background: #ff7800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        #popupLojaFechada button:hover {
            background: #e66a00;
        }
		
		.popup-horarios {
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
        }
        .popup-horarios.ativo {
          opacity: 1;
          pointer-events: auto;
        }
        .popup-horarios .popup-conteudo {
          background: #fff;
          padding: 20px;
          border-radius: 8px;
          max-width: 90%;
          width: 400px;
          text-align: center;
        }
        .popup-horarios h3 , .popup-conteudo h3 {
		  font-size: 1.5rem;
         
        }
        .popup-horarios ul li {
          margin: 5px 0;
          font-size: 1.2rem;
        }
		
		/* üîπ Spinner */
		.loading-spinner {
		border: 3px solid #f3f3f3;
		border-top: 3px solid #007BFF;
		border-radius: 50%;
		width: 18px;
		height: 18px;
		animation: spin 1s linear infinite;
		display: inline-block;
		vertical-align: middle;
		margin-right: 8px; /* Espa√ßo entre o spinner e o texto */
		}
		
		@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
		}
        
        		
    </style>
</head>
<body>

<header style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 5%; background: #ff7800;">
  <div id="logo"><img id="logo-img" alt="Logomarca"></div>
  <div id="statusLoja" onclick="mostrarPopupHorarios()" style="cursor: pointer; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; transition: background 0.3s;">
    Carregando...
  </div>
</header>

<nav>
    <div class="categorias" id="categorias"></div>
    <div class="pesquisa">
        <input type="text" id="pesquisaInput" placeholder="Pesquisar produtos...">
    </div>
</nav>

<div class="botao-carrinho" onclick="toggleCarrinho()">üõçÔ∏è<span id="contadorCarrinho">0</span></div>

<section id="produtos"></section>

<div id="carrinho">
    <h3>Sacola</h3>
    <ul id="listaCarrinho"></ul>
    <p id="espacototalCarrinho"><strong>Total: <span id="totalCarrinho">R$ 0,00</span></strong></p>
    <button id="btfinalizarpedido" onclick="finalizarPedido()">Finalizar Pedido</button>
</div>

<div id="popupPedido">
    <div class="popup-conteudo">
        <h3>Finalizar Pedido</h3>
		<div id="tipoContainer">
  <h4 style="margin-bottom: 5px;">Escolha o tipo do pedido:</h4>
  <div id="tipoOptions" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
</div>		
		<label>N√∫mero da Mesa:
            <input type="number" id="mesa" />
        </label>
        <label>Nome:
			<input type="text" id="nomeCliente" />
		</label>
		<label>WhatsApp:
			<input type="text" id="whatsappCliente" pattern="\d{2} \d{5}-\d{4}" placeholder="Ex.: 99 99999-9999" />
		</label>
        <label>Endere√ßo:
            <input type="text" id="endereco" />
        </label>
        <label>N√∫mero da Casa:
            <input type="number" id="numeroCasa" />
        </label>
        <label>Bairro:
            <select id="bairroSelect">
                <option value="">Selecione o bairro</option>
            </select>
        </label>
        <label>Forma de Pagamento:
            <select id="formaPagamento" onchange="toggleTrocoField()">
                <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
				<option value="Dinheiro">Dinheiro</option>
                <option value="Pix">Pix</option>				
            </select>
        </label>
        <label id="labelTroco" style="display:none;">Troco para quanto?
            <input type="number" id="troco" min="0" step="0.01" placeholder="Ex: 50,00" />
        </label>
        <label>Observa√ß√£o:
            <input type="text" id="observacao" />
        </label>

        <p id="totalPedido" style="font-weight:bold; font-size:1.2rem; margin-top:5px;">
            Total do Pedido: R$ 0,00
        </p>		
		
		<div>
			<button id="btenviarpedido" onclick="enviarPedido()">
				<span class="loading-spinner" style="display: none;"></span>
				<span id="text-enviar-pedido">Enviar pedido</span>
			</button>
			<button id="btcancelar" onclick="fecharPopup()">Cancelar</button>
		</div>
		
    </div>
</div>

<div id="popupAdicionais">
    <div class="popup-conteudo">
        <h3 id="adicionalProdutoNome">Adicionais para [Nome do Produto]</h3>
        
        <div id="listaSabores" class="adicionais-group"></div>
        <div id="listaAdicionais" class="adicionais-group"></div>
        
        <p>
            Total do Produto com Adicionais:
            <strong id="totalProdutoComAdicionais">R$ 0,00</strong>
        </p>
        <div>
            <button id="btAdicionarAoCarrinhoComAdicionais" onclick="adicionarAoCarrinhoComAdicionais()">Adicionar √† Sacola</button>
            <button id="btCancelarAdicionais" onclick="fecharPopupAdicionais()">Cancelar</button>
        </div>
    </div>
</div>

<div id="popupLojaFechada">
    <div class="popup-conteudo">
        <h3>Loja Fechada!</h3>
        <p id="mensagemHorario"></p>
        <button onclick="fecharPopupLojaFechada()">Entendi</button>
    </div>
</div>

<div id="popupHorarios" class="popup-horarios">
  <div class="popup-conteudo">
    <h3>‚è∞ Hor√°rios de Funcionamento</h3>
    <ul id="listaHorariosFuncionamento" style="list-style: none; padding: 0;"></ul>
    <button id="btVoltar" onclick="fecharPopupHorarios()">Fechar</button>
  </div>
</div>

<footer>
  <div class="footer-margem">
    <p id="footer-store-name"></p>
    <p>Siga-nos:
        <a id="instagram-link" href="#" target="_blank">Instagram</a> |
        <a id="facebook-link" href="#" target="_blank">Facebook</a> |
        <a id="whatsapp-link" href="#" target="_blank">WhatsApp</a>
    </p>
    <p id="footer-address"></p>
    <p id="footer-contact-phones"></p>
  </div>
  <div class="footer-desenvolvido">
    <p>Desenvolvido por: <a href="#" target="_blank">Emerson Marks</a></p>
  </div>
</footer>

<script>
    const SHEET_URL_PRODUTOS = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=0";
    const SHEET_URL_BAIRROS = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=498087514";
    const SHEET_URL_ADICIONAIS = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=290055706";
    const SHEET_URL_CONFIGURACOES = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=1791928589";
    const SHEET_URL_CATEGORIAS_ORDEM = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=1852665090";
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwiK1VBRTssi2-bl_DR_3pG-1zf7tePbdmgZ0k2b6hQT3ajda4VVPzyNJUjkFdkrhdO/exec";
    const SHEET_URL_SABORES = "https://docs.google.com/spreadsheets/d/12Hrr5dQHt82ptzLpCmN5bCJFszQ7dFcO06GxLadBRoQ/gviz/tq?tqx=out:json&gid=549050232"; // Novo URL para a aba de sabores

	let nome = localStorage.getItem("nomeCliente") || "";

    let produtos = [];
    let bairrosEntrega = {};
    let adicionais = [];
    let sabores = []; // Nova vari√°vel para armazenar os sabores
    let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    let horarioFuncionamento = {};
    let isLojaAbertaStatus = false;
    let categoriasOrdem = [];
    let whatsappOrderNumber = "";

    let produtoSelecionadoParaAdicionais = null;
    let adicionaisSelecionadosTemp = [];
    let saboresSelecionadosTemp = []; // Nova vari√°vel para os sabores selecionados

    let tipoSelecionado = "";

    const diasDaSemana = ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"];

    document.addEventListener("DOMContentLoaded", async () => {
        await fetchConfiguracoes();

        await Promise.all([
            fetchCategoriasOrdem(),
            fetch(SHEET_URL_PRODUTOS)
                .then(res => res.text())
                .then(text => JSON.parse(text.substr(47).slice(0, -2)))
                .then(json => {
                    const rows = json.table.rows;
                    produtos = rows
                        .filter(row => row.c[0]?.v?.toLowerCase() === "sim")
                        .map(row => {
                            const c = row.c;
                            return {
                                nome: c[1]?.v,
                                categoria: c[2]?.v,
                                descricao: c[3]?.v,
                                preco: parseFloat(c[4]?.v),
                                tipoAdicional: c[5]?.v,
                                minAdicionais: parseInt(c[6]?.v) || 0,
                                maxAdicionais: parseInt(c[7]?.v) || 999,
                                imagem: c[8]?.v,
                                tipoSabor: c[9]?.v, // Nova coluna J (Sabores)
                                maxSabores: parseInt(c[10]?.v) || 1 // Nova coluna K (Maximo Sabores)
                            };
                        });
                }),
            fetch(SHEET_URL_BAIRROS)
                .then(res => res.text())
                .then(text => JSON.parse(text.substr(47).slice(0, -2)))
                .then(json => {
                    const rows = json.table.rows;
                    bairrosEntrega = {};
                    const bairroSelect = document.getElementById("bairroSelect");
                    bairroSelect.innerHTML = '<option value="">Selecione o bairro</option>';

                    rows.forEach(row => {
                        const c = row.c;
                        const nomeBairro = c[0]?.v;
                        const valorEntrega = parseFloat(c[1]?.v) || 0;
                        bairrosEntrega[nomeBairro] = valorEntrega;

                        const option = document.createElement("option");
                        option.value = nomeBairro;
                        option.textContent = `${nomeBairro} - R$ ${valorEntrega.toFixed(2).replace('.', ',')}`;
                        bairroSelect.appendChild(option);
                    });
                }),
            fetch(SHEET_URL_ADICIONAIS)
                .then(res => res.text())
                .then(text => JSON.parse(text.substr(47).slice(0, -2)))
                .then(json => {
                    const rows = json.table.rows;
                    adicionais = rows.map(row => {
                        const c = row.c;
                        return {
                            tipo: c[0]?.v,
                            nome: c[1]?.v,
                            preco: parseFloat(c[2]?.v) || 0
                        };
                    });
                }),
            fetch(SHEET_URL_SABORES)
                .then(res => res.text())
                .then(text => JSON.parse(text.substr(47).slice(0, -2)))
                .then(json => {
                    const rows = json.table.rows;
                    sabores = rows.map(row => {
                        const c = row.c;
                        return {
                            tipo: c[0]?.v,
                            nome: c[1]?.v,
                            preco: parseFloat(c[2]?.v) || 0
                        };
                    });
                })
        ]);

        checkHorarioFuncionamento();
        renderCategorias();
        renderProdutos(produtos);
        renderCarrinho();

        document.getElementById("pesquisaInput").addEventListener("input", e => {
            const termo = e.target.value.toLowerCase();
            const filtrados = produtos.filter(p => p.nome.toLowerCase().includes(termo));
            renderProdutos(filtrados);
        });

        document.getElementById("bairroSelect").addEventListener("change", () => {
            mostrarValorEntrega(document.getElementById("bairroSelect").value);
            atualizarTotalPedido();
        });

        document.getElementById("formaPagamento").addEventListener("change", toggleTrocoField);

		document.getElementById("nomeCliente").closest("label").style.display = "none";
        document.getElementById("whatsappCliente").closest("label").style.display = "none";
        document.getElementById("mesa").closest("label").style.display = "none";
        document.getElementById("endereco").closest("label").style.display = "none";
        document.getElementById("numeroCasa").closest("label").style.display = "none";
        document.getElementById("bairroSelect").closest("label").style.display = "none";
        document.getElementById("formaPagamento").closest("label").style.display = "none";
		document.getElementById("observacao").closest("label").style.display = "none";		
        document.getElementById("labelTroco").style.display = "none";

    });

    async function fetchConfiguracoes() {
        try {
            const response = await fetch(SHEET_URL_CONFIGURACOES);
            const text = await response.text();
            const json = JSON.parse(text.substr(47).slice(0, -2));
            const rows = json.table.rows;

            if (rows.length > 0) {
                const configRow = rows[0].c;

                const storeName = configRow[0]?.v;
                if (storeName) {
                    document.getElementById("footer-store-name").textContent = storeName;
                }

                const logoUrl = configRow[1]?.v;
                if (logoUrl) {
                    document.getElementById("logo-img").src = logoUrl;
					document.getElementById("logo-img").alt = "Logomarca";

                }

                const instagramLink = configRow[2]?.v;
                const facebookLink = configRow[3]?.v;
                const whatsappLink = configRow[4]?.v;

                if (instagramLink) {
                    document.getElementById("instagram-link").href = instagramLink;
                }
                if (facebookLink) {
                    document.getElementById("facebook-link").href = facebookLink;
                }
                if (whatsappLink) {
                    document.getElementById("whatsapp-link").href = 'https://wa.me/' + whatsappLink;
                    whatsappOrderNumber = whatsappLink;
                }

                const footerAddress = configRow[5]?.v;
                if (footerAddress) {
                    document.getElementById("footer-address").textContent = footerAddress;
                }

                const contactPhones = configRow[6]?.v;
                const deliveryAtivo = configRow[12]?.v?.toLowerCase() === "sim";
                const retiradaAtivo = configRow[13]?.v?.toLowerCase() === "sim";
                const mesaAtivo = configRow[14]?.v?.toLowerCase() === "sim";
                renderOpcoesTipoPedido({ delivery: deliveryAtivo, retirada: retiradaAtivo, mesa: mesaAtivo });
                if (contactPhones) {
                    document.getElementById("footer-contact-phones").textContent = contactPhones;
                }

                horarioFuncionamento = {};
                rows.forEach(row => {
                    const c = row.c;
                    if (c[7]?.v) {
                        horarioFuncionamento[c[7].v] = {
                            abertura: c[8]?.f,
                            almocoInicio: c[9]?.f,
                            almocoFim: c[10]?.f,
                            fechamento: c[11]?.f
                        };
                    }
                });
            }

        } catch (error) {
            horarioFuncionamento = null;
        }
    }

    async function fetchCategoriasOrdem() {
        try {
            const response = await fetch(SHEET_URL_CATEGORIAS_ORDEM);
            const text = await response.text();
            const json = JSON.parse(text.substr(47).slice(0, -2));
            const rows = json.table.rows;

            categoriasOrdem = rows.map(row => {
                const c = row.c;
                return {
                    posicao: parseInt(c[0]?.v),
                    nome: c[1]?.v,
                    descricao: c[2]?.v
                };
            }).sort((a, b) => a.posicao - b.posicao);

        } catch (error) {
            console.error("Erro ao carregar a ordem das categorias:", error);
            categoriasOrdem = [];
        }
    }

	async function checkHorarioFuncionamento() {
		if (!horarioFuncionamento) {
			exibirPopupLojaFechada("N√£o foi poss√≠vel carregar os hor√°rios de funcionamento.");
			isLojaAbertaStatus = false;
			updateFinalizarPedidoButton();
			return;
		}
		
		try {
			const response = await fetch('https://script.google.com/macros/s/AKfycbyChAN4TbWQwfqAOuPu_zn1sI8uMiBYkOXaRNYL7sJIClWYgWOvAXonUo1IqBCH6Wki/exec');
			const data = await response.json();
			const serverTime = new Date(data.datetime);
			const diaAtual = diasDaSemana[serverTime.getDay()];
			const horaAtual = serverTime.getHours() * 60 + serverTime.getMinutes();
		
			const configDia = horarioFuncionamento[diaAtual];
		
			if (!configDia || !configDia.abertura || !configDia.fechamento) {
				exibirPopupLojaFechada(`N√£o funcionamos na ${diaAtual}.`);
				isLojaAbertaStatus = false;
				updateFinalizarPedidoButton();
				return;
			}
		
			const parseTime = (timeStr) => {
				if (!timeStr) return -1;
				const [hours, minutes] = timeStr.split(':').map(Number);
				return hours * 60 + minutes;
			};
		
			const abertura = parseTime(configDia.abertura);
			const fechamento = parseTime(configDia.fechamento);
			const almocoInicio = parseTime(configDia.almocoInicio);
			const almocoFim = parseTime(configDia.almocoFim);
		
			let isLojaAbertaLocal = false;
			let mensagem = "";
		
			if (abertura === -1 || fechamento === -1) {
				mensagem = `Os hor√°rios de abertura ou fechamento para ${diaAtual} n√£o est√£o configurados corretamente.`;
			} else if (horaAtual >= abertura && horaAtual < fechamento) {
				if (almocoInicio !== -1 && almocoFim !== -1 && horaAtual >= almocoInicio && horaAtual < almocoFim) {
					mensagem = `Ol√° ${nome}. Fizemos uma pausa e retornaremos √†s ${configDia.almocoFim}.`;
				} else {
					isLojaAbertaLocal = true;
					mensagem = `Ol√° ${nome}. Estamos abertos at√© as ${configDia.fechamento}! Fa√ßa seu pedido.`;
				}
			} else {
				mensagem = `Ol√° ${nome}. No momento estamos fechados. Nosso hor√°rio de funcionamento na ${diaAtual} √© de ${configDia.abertura} √†s ${configDia.fechamento}.`;
			}
		
			isLojaAbertaStatus = isLojaAbertaLocal;
		
			if (!isLojaAbertaStatus) {
				exibirPopupLojaFechada(mensagem);
			}
		
			updateFinalizarPedidoButton();
			atualizarStatusLojaVisual();
		
		} catch (error) {
			console.error("Erro ao obter hora do servidor:", error);
			exibirPopupLojaFechada("N√£o foi poss√≠vel verificar o hor√°rio do servidor.");
			isLojaAbertaStatus = false;
			updateFinalizarPedidoButton();
		}
	}


    function atualizarStatusLojaVisual() {
      const statusEl = document.getElementById("statusLoja");
      if (!statusEl) return;
    
      if (isLojaAbertaStatus) {
        statusEl.textContent = "üü¢ Loja Aberta";
        statusEl.style.background = "#28a745";
        statusEl.style.color = "#fff";
      } else {
        statusEl.textContent = "üî¥ Loja Fechada";
        statusEl.style.background = "#dc354f";
        statusEl.style.color = "#fff";
      }
    }

    function exibirPopupLojaFechada(mensagem) {
        document.getElementById("mensagemHorario").textContent = mensagem;
        document.getElementById("popupLojaFechada").classList.add("ativo");
    }

    function fecharPopupLojaFechada() {
        document.getElementById("popupLojaFechada").classList.remove("ativo");
    }

    function updateFinalizarPedidoButton() {
        const finalizarBtn = document.getElementById("btfinalizarpedido");
        if (isLojaAbertaStatus) {
            finalizarBtn.disabled = false;
            finalizarBtn.style.backgroundColor = "green";
            finalizarBtn.textContent = "Finalizar Pedido";
        } else {
            finalizarBtn.disabled = true;
            finalizarBtn.style.backgroundColor = "#ccc";
            finalizarBtn.textContent = "Loja Fechada";
        }
    }

    function renderCategorias() {
        const catContainer = document.getElementById("categorias");
        catContainer.innerHTML = "";

        const btnTodas = document.createElement("button");
        btnTodas.textContent = "Todas";
        btnTodas.onclick = () => renderProdutos(produtos);
        catContainer.appendChild(btnTodas);

        const categoriasComProdutos = [...new Set(produtos.map(p => p.categoria))];

        let categoriasParaRenderizar = categoriasOrdem
            .filter(catOrder => categoriasComProdutos.includes(catOrder.nome))
            .map(catOrder => catOrder.nome);

        categoriasComProdutos.forEach(cat => {
            if (!categoriasParaRenderizar.includes(cat)) {
                categoriasParaRenderizar.push(cat);
            }
        });

        categoriasParaRenderizar.sort((a, b) => {
            const indexA = categoriasOrdem.findIndex(c => c.nome === a);
            const indexB = categoriasOrdem.findIndex(c => c.nome === b);

            if (indexA === -1 && indexB === -1) {
                return a.localeCompare(b);
            }
            if (indexA === -1) {
                return 1;
            }
            if (indexB === -1) {
                return -1;
            }
            return indexA - indexB;
        });


        categoriasParaRenderizar.forEach(cat => {
            const btn = document.createElement("button");
            btn.textContent = cat;
            btn.onclick = () => {
                const filtrados = produtos.filter(p => p.categoria === cat);
                renderProdutos(filtrados);
            };
            catContainer.appendChild(btn);
        });
    }

    function renderProdutos(lista) {
        const container = document.getElementById("produtos");
        container.innerHTML = "";

        const categoriasMap = {};
        lista.forEach(p => {
            if (!categoriasMap[p.categoria]) {
                categoriasMap[p.categoria] = [];
            }
            categoriasMap[p.categoria].push(p);
        });

        const categoriasOrdenadas = categoriasOrdem
            .filter(cat => categoriasMap[cat.nome])
            .map(cat => cat.nome);

        const existingProductCategories = [...new Set(lista.map(p => p.categoria))];
        existingProductCategories.forEach(cat => {
            if (!categoriasOrdenadas.includes(cat)) {
                categoriasOrdenadas.push(cat);
            }
        });
        
        categoriasOrdenadas.sort((a, b) => {
            const indexA = categoriasOrdem.findIndex(c => c.nome === a);
            const indexB = categoriasOrdem.findIndex(c => c.nome === b);

            if (indexA === -1 && indexB === -1) {
                return a.localeCompare(b);
            }
            if (indexA === -1) {
                return 1;
            }
            if (indexB === -1) {
                return -1;
            }
            return indexA - indexB;
        });

        categoriasOrdenadas.forEach(categoria => {
            const tituloCat = document.createElement("h2");
            tituloCat.textContent = categoria;
            tituloCat.style.width = "100%";
            tituloCat.style.borderBottom = "2px solid #333";
            tituloCat.style.margin = "1rem 0 0.5rem 0";
            container.appendChild(tituloCat);

            const categoriaInfo = categoriasOrdem.find(c => c.nome === categoria);
            if (categoriaInfo && categoriaInfo.descricao) {
                const descricaoP = document.createElement("p");
                descricaoP.textContent = categoriaInfo.descricao;
                descricaoP.style.width = "100%";
                descricaoP.style.marginTop = "-15px";
                descricaoP.style.fontStyle = "italic";
                descricaoP.style.color = "#555";
                container.appendChild(descricaoP);
            }

            categoriasMap[categoria].sort((a, b) => a.nome.localeCompare(b.nome));

            categoriasMap[categoria].forEach((p, index) => {
                const id = `${categoria}_${index}`.replace(/\s+/g, "_");
                const card = document.createElement("div");
                card.className = "produto";

                let precoDisplay;
                if (p.tipoSabor) {
                    const saboresDoTipo = sabores.filter(s => s.tipo === p.tipoSabor);
                    const menorPreco = saboresDoTipo.length > 0
                        ? Math.min(...saboresDoTipo.map(s => s.preco))
                        : 0;
                    if (menorPreco === 0) {
                        precoDisplay = `A partir de Gr√°tis`;
                    } else {
                        precoDisplay = `A partir de ${menorPreco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    }
                } else {
                    precoDisplay = p.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                }

                card.innerHTML = `
                    <img src="${p.imagem}" alt="${p.nome}" loading="lazy">
                    <h3>${p.nome}</h3>
                    <p>${p.descricao}</p>
                    <p class="valor"><strong>${precoDisplay}</strong></p>
                    <div class="quantidade-container">
                        <button onclick="alterarQuantidade('subtrair', '${id}')">-</button>
                        <span id="qtd_${id}">1</span>
                        <button onclick="alterarQuantidade('adicionar', '${id}')">+</button>
                    </div>
                    <button onclick='prepararParaAdicionarCarrinho(${JSON.stringify(p).replace(/'/g, "\\'")}, "${id}")'>Adicionar</button>`;
                container.appendChild(card);
            });
        });
    }

    function alterarQuantidade(acao, id) {
        const span = document.getElementById(`qtd_${id}`);
        let qtdAtual = parseInt(span.textContent);
        if (acao === 'adicionar') {
            qtdAtual += 1;
        } else if (acao === 'subtrair' && qtdAtual > 1) {
            qtdAtual -= 1;
        }
        span.textContent = qtdAtual;
    }

    function prepararParaAdicionarCarrinho(produto, id) {
        const qtd = parseInt(document.getElementById(`qtd_${id}`).textContent);
        if (qtd <= 0 || isNaN(qtd)) {
            alert("Quantidade inv√°lida!");
            return;
        }

        produtoSelecionadoParaAdicionais = { ...produto, quantidade: qtd, idOriginal: id };
        adicionaisSelecionadosTemp = [];
        saboresSelecionadosTemp = [];

        if (produto.tipoAdicional && produto.tipoAdicional !== "N√£o" || produto.tipoSabor) {
            abrirPopupAdicionais(produto);
        } else {
            adicionarAoCarrinhoFinal({
                ...produtoSelecionadoParaAdicionais,
                adicionais: [],
                sabores: []
            });
        }
    }
    
    function abrirPopupAdicionais(produto) {
        document.getElementById("adicionalProdutoNome").textContent = `Op√ß√µes para ${produto.nome}`;
        const listaSaboresDiv = document.getElementById("listaSabores");
        const listaAdicionaisDiv = document.getElementById("listaAdicionais");
        listaSaboresDiv.innerHTML = "";
        listaAdicionaisDiv.innerHTML = "";
        
        listaSaboresDiv.style.display = "none";
        listaAdicionaisDiv.style.display = "none";

        // L√≥gica para os Sabores
        if (produto.tipoSabor) {
            const saboresFiltrados = sabores.filter(s => s.tipo === produto.tipoSabor);
            if (saboresFiltrados.length > 0) {
				listaSaboresDiv.style.display = "block";
				const saboresTitle = document.createElement("h4");
                saboresTitle.textContent = "Sabores";
                listaSaboresDiv.appendChild(saboresTitle);

				const infoLimitSabores = document.createElement("p");
				infoLimitSabores.className = "info-limit";
				infoLimitSabores.id = "saboresLimitText";
				listaSaboresDiv.appendChild(infoLimitSabores);

                saboresFiltrados.forEach(sabor => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "adicional-item";
                    const precoSaborText = sabor.preco === 0 ? 'Gr√°tis' : `${sabor.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    itemDiv.innerHTML = `<label>
                        <input type="checkbox" data-type="sabor" data-nome="${sabor.nome}" data-preco="${sabor.preco.toFixed(2)}">
                        ${sabor.nome}
                    </label>
                    <span>${precoSaborText}</span>`;
                    listaSaboresDiv.appendChild(itemDiv);
                });
            }
        }

        // L√≥gica para os Adicionais
        if (produto.tipoAdicional && produto.tipoAdicional !== "N√£o") {
            const adicionaisFiltrados = adicionais.filter(a => a.tipo === produto.tipoAdicional);
            if (adicionaisFiltrados.length > 0) {
				listaAdicionaisDiv.style.display = "block";
				const adicionaisTitle = document.createElement("h4");
                adicionaisTitle.textContent = "Adicionais";
                listaAdicionaisDiv.appendChild(adicionaisTitle);

				const infoLimitAdicionais = document.createElement("p");
				infoLimitAdicionais.className = "info-limit";
				infoLimitAdicionais.id = "adicionalLimitText";
				listaAdicionaisDiv.appendChild(infoLimitAdicionais);

                adicionaisFiltrados.forEach(adicional => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "adicional-item";
                    const precoAdicionalText = adicional.preco === 0 ? 'Gr√°tis' : `+ ${adicional.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    itemDiv.innerHTML = `<label>
                        <input type="checkbox" data-type="adicional" data-nome="${adicional.nome}" data-preco="${adicional.preco.toFixed(2)}">
                        ${adicional.nome}
                    </label>
                    <span>${precoAdicionalText}</span>`;
                    listaAdicionaisDiv.appendChild(itemDiv);
                });
            }
        }
        
        document.querySelectorAll('#popupAdicionais input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateTotalProdutoComSabores);
        });

        updateTotalProdutoComSabores();
        document.getElementById("popupAdicionais").classList.add("ativo");
    }

    function fecharPopupAdicionais() {
        document.getElementById("popupAdicionais").classList.remove("ativo");
        produtoSelecionadoParaAdicionais = null;
        adicionaisSelecionadosTemp = [];
        saboresSelecionadosTemp = [];
    }

    function updateTotalProdutoComSabores() {
        let totalProduto = produtoSelecionadoParaAdicionais.preco;
        adicionaisSelecionadosTemp = [];
        saboresSelecionadosTemp = [];
		let maxSaborPreco = 0;

        const checkboxes = document.querySelectorAll('#popupAdicionais input[type="checkbox"]');
        let selectedSaboresCount = 0;
        let selectedAdicionaisCount = 0;

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                if (checkbox.dataset.type === "sabor") {
                    selectedSaboresCount++;
					const precoSabor = parseFloat(checkbox.dataset.preco);
					if (precoSabor > maxSaborPreco) {
						maxSaborPreco = precoSabor;
					}
                } else if (checkbox.dataset.type === "adicional") {
                    selectedAdicionaisCount++;
                }
            }
        });
		
		totalProduto += maxSaborPreco;

        const maxSaboresAllowed = produtoSelecionadoParaAdicionais.maxSabores;
        const minSaboresAllowed = 1;
        const maxAdicionaisAllowed = produtoSelecionadoParaAdicionais.maxAdicionais;
        const minAdicionaisAllowed = produtoSelecionadoParaAdicionais.minAdicionais;

        checkboxes.forEach(checkbox => {
            const isSabor = checkbox.dataset.type === "sabor";
            const isAdicional = checkbox.dataset.type === "adicional";

            if (isSabor && selectedSaboresCount >= maxSaboresAllowed && !checkbox.checked) {
                checkbox.disabled = true;
            } else if (isAdicional && selectedAdicionaisCount >= maxAdicionaisAllowed && maxAdicionaisAllowed !== 999 && !checkbox.checked) {
                checkbox.disabled = true;
            } else {
                checkbox.disabled = false;
            }
            
            if (checkbox.checked) {
                const nome = checkbox.dataset.nome;
                const preco = parseFloat(checkbox.dataset.preco);
                
                if (isAdicional) {
                    totalProduto += preco;
                    adicionaisSelecionadosTemp.push({ nome: nome, preco: preco });
                } else if (isSabor) {
                    saboresSelecionadosTemp.push({ nome: nome, preco: preco });
                }
            }
        });

        const adicionalLimitText = document.getElementById("adicionalLimitText");
        if (adicionalLimitText) {
            adicionalLimitText.textContent = "";
            let textToDisplay = "";
    
            if (minAdicionaisAllowed !== 0 && maxAdicionaisAllowed !== 999) {
                textToDisplay = `Selecione de ${minAdicionaisAllowed} a ${maxAdicionaisAllowed} adicional(is). Selecionados: ${selectedAdicionaisCount}`;
            } else if (minAdicionaisAllowed === 0 && maxAdicionaisAllowed !== 999) {
                textToDisplay = `Selecione at√© ${maxAdicionaisAllowed} adicional(is). Selecionados: ${selectedAdicionaisCount}`;
            } else if (minAdicionaisAllowed !== 0 && maxAdicionaisAllowed === 999) {
                textToDisplay = `Selecione pelo menos ${minAdicionaisAllowed} adicional(is). Selecionados: ${selectedAdicionaisCount}`;
            }

            if (textToDisplay) {
                adicionalLimitText.textContent = textToDisplay;
                const isMinViolated = minAdicionaisAllowed > 0 && selectedAdicionaisCount < minAdicionaisAllowed;
                const isMaxViolated = maxAdicionaisAllowed !== 999 && selectedAdicionaisCount > maxAdicionaisAllowed;
                adicionalLimitText.style.color = (isMinViolated || isMaxViolated) ? "red" : "#666";
            }
        }

        const saboresLimitText = document.getElementById("saboresLimitText");
        if(saboresLimitText) {
            saboresLimitText.textContent = "";
            if(produtoSelecionadoParaAdicionais.tipoSabor){
                saboresLimitText.textContent = `Selecione de 1 a ${maxSaboresAllowed} sabor(es). Selecionados: ${selectedSaboresCount}`;
                saboresLimitText.style.color = (selectedSaboresCount > maxSaboresAllowed || selectedSaboresCount < minSaboresAllowed) ? "red" : "#666";
            }
        }
        
        const totalComAdicionais = totalProduto;
        document.getElementById("totalProdutoComAdicionais").textContent = totalComAdicionais.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    function adicionarAoCarrinhoComAdicionais() {
        const produto = produtoSelecionadoParaAdicionais;
        const minSaboresAllowed = 1;
        const maxSaboresAllowed = produto.maxSabores;
        const minAdicionaisAllowed = produto.minAdicionais;
        const maxAdicionaisAllowed = produto.maxAdicionais;

        if (produto.tipoSabor && (saboresSelecionadosTemp.length < minSaboresAllowed || saboresSelecionadosTemp.length > maxSaboresAllowed)) {
            alert(`Voc√™ deve selecionar de 1 a ${maxSaboresAllowed} sabor(es) para este produto.`);
            return;
        }
        
        if (adicionaisSelecionadosTemp.length < minAdicionaisAllowed || adicionaisSelecionadosTemp.length > maxAdicionaisAllowed) {
            let message = "";
            if(minAdicionaisAllowed > 0 && maxAdicionaisAllowed !== 999) {
                message = `Voc√™ deve selecionar de ${minAdicionaisAllowed} a ${maxAdicionaisAllowed} adicionais.`;
            } else if (minAdicionaisAllowed === 0 && maxAdicionaisAllowed !== 999) {
                message = `Voc√™ deve selecionar at√© ${maxAdicionaisAllowed} adicionais.`;
            } else if (minAdicionaisAllowed > 0 && maxAdicionaisAllowed === 999) {
                message = `Voc√™ deve selecionar pelo menos ${minAdicionaisAllowed} adicionais.`;
            }
            if (message) {
                alert(message);
                return;
            }
        }
		
		let maxSaborPreco = 0;
		if (saboresSelecionadosTemp.length > 0) {
            maxSaborPreco = Math.max(...saboresSelecionadosTemp.map(s => s.preco));
        }

        const produtoComOpcoes = {
            ...produto,
            quantidade: produto.quantidade,
            adicionais: adicionaisSelecionadosTemp,
            sabores: saboresSelecionadosTemp,
			maxSaborPreco: maxSaborPreco,
        };
        adicionarAoCarrinhoFinal(produtoComOpcoes);
        fecharPopupAdicionais();
    }


    function adicionarAoCarrinhoFinal(item) {
        const itemExistenteIndex = carrinho.findIndex(carrinhoItem =>
            carrinhoItem.nome === item.nome &&
            JSON.stringify(carrinhoItem.adicionais) === JSON.stringify(item.adicionais) &&
            JSON.stringify(carrinhoItem.sabores) === JSON.stringify(item.sabores)
        );

        if (itemExistenteIndex > -1) {
            carrinho[itemExistenteIndex].quantidade += item.quantidade;
        } else {
            carrinho.push(item);
        }

        localStorage.setItem("carrinho", JSON.stringify(carrinho));
        renderCarrinho();

        const idProdutoAtual = produtoSelecionadoParaAdicionais.idOriginal;
        if (idProdutoAtual) {
            document.getElementById(`qtd_${idProdutoAtual}`).textContent = 1;
        }

        const botaoCarrinho = document.querySelector(".botao-carrinho");
        botaoCarrinho.classList.add("animate-cart");
        setTimeout(() => {
            botaoCarrinho.classList.remove("animate-cart");
        }, 500);
    }

    function renderCarrinho() {
        const lista = document.getElementById("listaCarrinho");
        const contador = document.getElementById("contadorCarrinho");
        const totalSpan = document.getElementById("totalCarrinho");
        lista.innerHTML = "";
        let totalItens = 0;
        let valorTotal = 0;

        carrinho.forEach((p, i) => {
            totalItens += p.quantidade;
            let precoDisplay = p.preco; // Pre√ßo base
            let precoTotalItem = p.preco; // Pre√ßo para c√°lculo do total
            let descAdicionais = "";
            let descSabores = "";

            if (p.sabores && p.sabores.length > 0) {
                const maxSaborPreco = Math.max(...p.sabores.map(s => s.preco));
                precoDisplay += maxSaborPreco; // Adiciona o sabor mais caro ao pre√ßo de exibi√ß√£o
                precoTotalItem += maxSaborPreco;
                p.sabores.forEach(s => {
                    descSabores += `\n        ‚Ä¢ ${s.nome}`;
                });
            }

            if (p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(ad => {
                    precoTotalItem += ad.preco; // Adiciona o adicional somente ao c√°lculo do total
                    const precoAdicionalText = ad.preco === 0 ? "Gr√°tis" : `${(ad.preco * p.quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    descAdicionais += `\n        + ${ad.nome} (${precoAdicionalText})`;
                });
            }

            valorTotal += precoTotalItem * p.quantidade;

            const li = document.createElement("li");
            li.innerHTML = `<span>
                <strong>${p.quantidade}x ${p.nome} - ${(precoDisplay * p.quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong><br>
                ${descSabores ? `<small>Sabores:${descSabores}</small><br>` : ''}
                ${descAdicionais ? `<small>Adicionais:${descAdicionais}</small>` : ''}
            </span>
            <button onclick="removerItem(${i}, event)">X</button>`;
            lista.appendChild(li);
        });

        contador.textContent = totalItens;
        totalSpan.textContent = valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        atualizarTotalPedido();
    }

    function removerItem(index, event) {
        event.stopPropagation();
        carrinho.splice(index, 1);
        localStorage.setItem("carrinho", JSON.stringify(carrinho));
        renderCarrinho();
    }

    function toggleCarrinho() {
        document.getElementById("carrinho").classList.toggle("ativo");
    }

    document.addEventListener("click", function (event) {
        const carrinhoBox = document.getElementById("carrinho");
        const botaoCarrinho = document.querySelector(".botao-carrinho");
        const popupPedido = document.getElementById("popupPedido");
        const popupAdicionais = document.getElementById("popupAdicionais");
        const popupLojaFechada = document.getElementById("popupLojaFechada");

        if (
            carrinhoBox.classList.contains("ativo") &&
            !carrinhoBox.contains(event.target) &&
            !botaoCarrinho.contains(event.target) &&
            !popupPedido.contains(event.target) &&
            !popupAdicionais.contains(event.target) &&
            !popupLojaFechada.contains(event.target)
        ) {
            carrinhoBox.classList.remove("ativo");
        }
    });

    function finalizarPedido() {
        checkHorarioFuncionamento();

        if (!isLojaAbertaStatus) {
            return;
        }

        if (carrinho.length === 0) {
            alert("O carrinho est√° vazio!");
            return;
        }

        document.getElementById("carrinho").classList.remove("ativo");

        document.getElementById("nomeCliente").value = localStorage.getItem("nomeCliente") || "";
		document.getElementById("whatsappCliente").value = localStorage.getItem("whatsappCliente") || "";
        document.getElementById("endereco").value = localStorage.getItem("endereco") || "";
        document.getElementById("numeroCasa").value = localStorage.getItem("numeroCasa") || "";
        document.getElementById("bairroSelect").value = localStorage.getItem("bairro") || "";

        document.getElementById("formaPagamento").value = localStorage.getItem("formaPagamento") || "Cart√£o de Cr√©dito";

        toggleTrocoField();

        atualizarTotalPedido();

        const lastTipo = localStorage.getItem("tipoPedido");
        if (lastTipo) {
            const typeButtons = document.querySelectorAll(".card-tipo");
            typeButtons.forEach(button => {
                if (button.textContent.includes(lastTipo.replace("Retirada", "Retirar no Local").replace("Mesa", "Comer na Mesa"))) {
                    selecionarTipo(lastTipo, button);
                }
            });
        }
        
        document.getElementById("popupPedido").classList.add("ativo");
    }

    function fecharPopup() {
        document.getElementById("popupPedido").classList.remove("ativo");
    }

    function mostrarValorEntrega(bairro) {}

    function atualizarTotalPedido() {
        const totalProdutosCalculado = carrinho.reduce((acc, p) => {
            let precoComOpcoes = p.preco;
			
			let maxSaborPreco = 0;
            if (p.sabores && p.sabores.length > 0) {
                maxSaborPreco = Math.max(...p.sabores.map(s => s.preco));
            }
			precoComOpcoes += maxSaborPreco;

            if (p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(ad => precoComOpcoes += ad.preco);
            }
            return acc + precoComOpcoes * p.quantidade;
        }, 0);

        const bairro = document.getElementById("bairroSelect").value;
        const taxaEntrega = bairrosEntrega[bairro] || 0;
        let total = totalProdutosCalculado;

        if (tipoSelecionado === "Delivery") {
            total += taxaEntrega;
        }

        const totalPedidoSpan = document.getElementById("totalPedido");
        totalPedidoSpan.textContent = `Total do Pedido: R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    function toggleTrocoField() {
        const formaPagamento = document.getElementById("formaPagamento").value;
        const labelTroco = document.getElementById("labelTroco");

        if (formaPagamento === "Dinheiro") {
            labelTroco.style.display = "block";
        } else {
            labelTroco.style.display = "none";
            document.getElementById("troco").value = "";
        }
    }
	
    async function enviarPedido() {
        checkHorarioFuncionamento();

        if (!isLojaAbertaStatus) {
            return;
        }

        const btnEnviarPedido = document.getElementById("btenviarpedido");
        const spinner = btnEnviarPedido.querySelector('.loading-spinner');

        btnEnviarPedido.disabled = true;

        const tipo = tipoSelecionado;
        if (!tipo) {
            alert("Por favor, selecione o tipo do pedido.");
            btnEnviarPedido.disabled = false;
            return;
        }

        const nome = document.getElementById("nomeCliente").value.trim();
        const whatsapp = document.getElementById("whatsappCliente").value.trim();
        const observacao = document.getElementById("observacao").value.trim();
        
        const whatsappRegex = /^\d{2} \d{5}-\d{4}$/;
        
        if (!nome) {
            alert("Por favor, preencha o Nome.");
            btnEnviarPedido.disabled = false;
            return;
        }
        
        if (!whatsapp) {
            alert("Por favor, preencha o N√∫mero do WhatsApp.");
            btnEnviarPedido.disabled = false;
            return;
        }
        
        if (!whatsappRegex.test(whatsapp)) {
            alert("Formato de WhatsApp inv√°lido. Use o formato: xx xxxxx-xxxx");
            btnEnviarPedido.disabled = false;
            return;
        }

        let mesa = "";
        let endereco = "";
        let numeroCasa = "";
        let bairro = "";
        let formaPagamento = "";
        let troco = 0;
        let taxaEntrega = 0;

        if (tipo === "Delivery") {
            endereco = document.getElementById("endereco").value.trim();
            numeroCasa = document.getElementById("numeroCasa").value.trim();
            bairro = document.getElementById("bairroSelect").value;
            formaPagamento = document.getElementById("formaPagamento").value;
            troco = document.getElementById("troco").value.trim();
            taxaEntrega = bairrosEntrega[bairro] || 0;

            if (!endereco) {
                alert("Por favor, preencha o Endere√ßo.");
                btnEnviarPedido.disabled = false;
                return;
            }
            if (!numeroCasa) {
                alert("Por favor, preencha o N√∫mero da Casa.");
                btnEnviarPedido.disabled = false;
                return;
            }
            if (!bairro) {
                alert("Por favor, selecione o Bairro.");
                btnEnviarPedido.disabled = false;
                return;
            }
            if (!formaPagamento) {
                alert("Por favor, selecione a Forma de Pagamento.");
                btnEnviarPedido.disabled = false;
                return;
            }
            if (formaPagamento === "Dinheiro") {
                const trocoValor = parseFloat(troco.replace(',', '.'));
                if (!troco || isNaN(trocoValor)) {
                    alert("Por favor, informe um valor v√°lido para o troco.");
                    btnEnviarPedido.disabled = false;
                    return;
                }
            }
        } else if (tipo === "Retirada") {
            formaPagamento = document.getElementById("formaPagamento").value;
            troco = document.getElementById("troco").value.trim();

            if (!formaPagamento) {
                alert("Por favor, selecione a Forma de Pagamento.");
                btnEnviarPedido.disabled = false;
                return;
            }
            if (formaPagamento === "Dinheiro") {
                const trocoValor = parseFloat(troco.replace(',', '.'));
                if (!troco || isNaN(trocoValor)) {
                    alert("Por favor, informe um valor v√°lido para o troco.");
                    btnEnviarPedido.disabled = false;
                    return;
                }
            }
        } else if (tipo === "Mesa") {
            mesa = document.getElementById("mesa").value.trim();
            if (!mesa) {
                alert("Por favor, preencha o N√∫mero da Mesa.");
                btnEnviarPedido.disabled = false;
                return;
            }
        }
        
        let detalhesPedidoString = "";
        carrinho.forEach(p => {
            let precoUnitarioComSabores = p.preco;
            if (p.sabores && p.sabores.length > 0) {
                const maxSaborPreco = Math.max(...p.sabores.map(s => s.preco));
                precoUnitarioComSabores += maxSaborPreco;
            }
        
            detalhesPedidoString += `üîπ ${p.quantidade}x ${p.nome} - ${(precoUnitarioComSabores * p.quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}\n`;
        
            if (p.sabores && p.sabores.length > 0) {
                detalhesPedidoString += `        ‚Ä¢ Sabores: ${p.sabores.map(s => s.nome).join(', ')}\n`;
            }
            if (p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(ad => {
                    const precoAdicionalText = ad.preco === 0 ? "Gr√°tis" : `${(ad.preco * p.quantidade).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    detalhesPedidoString += `        + ${ad.nome} (${precoAdicionalText})\n`;
                });
            }
        });
        
        const totalProdutosComOpcoes = carrinho.reduce((acc, p) => {
            let precoItem = p.preco;
            let maxSaborPreco = 0;
            if (p.sabores && p.sabores.length > 0) {
                maxSaborPreco = Math.max(...p.sabores.map(s => s.preco));
            }
            precoItem += maxSaborPreco;
            if (p.adicionais && p.adicionais.length > 0) {
                p.adicionais.forEach(ad => precoItem += ad.preco);
            }
            return acc + precoItem * p.quantidade;
        }, 0);
        
        const totalPedidoFinal = totalProdutosComOpcoes + taxaEntrega;
        
        // Salva dados no localStorage
        localStorage.setItem("nomeCliente", nome);
        localStorage.setItem("whatsappCliente", whatsapp);
        localStorage.setItem("tipoPedido", tipo);
        if (tipo === "Retirada" || tipo === "Delivery") {
            localStorage.setItem("formaPagamento", formaPagamento);
        }
        if (tipo === "Delivery") {
            localStorage.setItem("endereco", endereco);
            localStorage.setItem("numeroCasa", numeroCasa);
            localStorage.setItem("bairro", bairro);
        }
        
        spinner.style.display = 'inline-block';
        btnEnviarPedido.disabled = true;

        try {
            await fetch(APPS_SCRIPT_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tipo: tipo,
                    mesa: mesa,
                    nomeCliente: nome,
                    whatsapp: whatsapp,
                    endereco: endereco,
                    numeroCasa: numeroCasa,
                    bairro: bairro,
                    formaPagamento: formaPagamento,
                    troco: formaPagamento === "Dinheiro" ? parseFloat(troco.replace(',', '.')) : 0,
                    totalPedido: totalPedidoFinal,
                    detalhesPedido: detalhesPedidoString,
                    observacao: observacao
                }),
            });

			alert('‚úÖ Pedido enviado com sucesso!');
            
            let msg = `üõí *Novo Pedido - ${tipo}*\n`;
            
            if (tipo === "Mesa") {
                msg += `*Mesa N¬∞:* ${mesa}\n`;
            }
            
            msg += `üë§ *Nome:* ${nome}\n`;
            msg += `üì¶ *Itens:*\n`;
            msg += detalhesPedidoString;

            msg += `\nüí∞ *Total dos Produtos:* ${totalProdutosComOpcoes.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}\n`;
            
            if (tipo === "Delivery") {
                msg += `üöö *Taxa de Entrega:* ${taxaEntrega.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}\n`;
            }
            
            msg += `üí∞ *Total:* ${totalPedidoFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}\n`;
            
            if (tipo !== "Mesa") {
                if (formaPagamento === "Dinheiro") {
                    msg += `üíµ *Pagamento:* ${formaPagamento} (Troco para R$ ${parseFloat(troco).toFixed(2).replace('.', ',')})\n\n`;
                } else {
                    msg += `üí≥ *Pagamento:* ${formaPagamento}\n\n`;
                }
            } else {
                msg += `\n`;
            }

            if (tipo === "Delivery") {
                msg += `üè† *Endere√ßo:* ${endereco}, N¬∫ ${numeroCasa}, Bairro ${bairro}\n`;
            }
            
            if (observacao) {
                msg += `*üìã Obs.:* ${observacao}\n`;
            }
            
            msg += `‚úÖ *Aguardo confirma√ß√£o!*`;
            
            
            spinner.style.display = 'none';
            btnEnviarPedido.disabled = false; 

            const url = `https://wa.me/${whatsappOrderNumber}?text=${encodeURIComponent(msg)}`;
            window.open(url, "_blank");

            carrinho = [];
            localStorage.removeItem("carrinho");
            renderCarrinho();
            fecharPopup();

        } catch (error) {
            console.error("Erro ao enviar pedido para o Apps Script:", error);
            alert("Erro ao finalizar o pedido. Por favor, tente novamente. Verifique o console do navegador para mais detalhes.");
        } finally {
            btnEnviarPedido.disabled = false;
            spinner.style.display = 'none';
        }
    }
	
    
function renderOpcoesTipoPedido({ delivery, retirada, mesa }) {
  const container = document.getElementById("tipoOptions");
  container.innerHTML = "";

  const opcoes = [
    { id: "Delivery", nome: "Delivery", ativo: delivery },
    { id: "Retirada", nome: "Retirar no Local", ativo: retirada },
    { id: "Mesa", nome: "Comer na Mesa", ativo: mesa },
  ];

  opcoes.forEach(opcao => {
    if (opcao.ativo) {
      const div = document.createElement("div");
      div.className = "card-tipo";
      div.textContent = opcao.nome;
      div.onclick = () => selecionarTipo(opcao.id, div);
      container.appendChild(div);
    }
  });
}


function selecionarTipo(tipo, elemento) {
    tipoSelecionado = tipo;
    document.querySelectorAll(".card-tipo").forEach(card => card.classList.remove("selecionado"));
    elemento.classList.add("selecionado");


	const nomeField = document.getElementById("nomeCliente").closest("label");
    const whatsappField = document.getElementById("whatsappCliente").closest("label");
    const mesaField = document.getElementById("mesa").closest("label");
    const enderecoField = document.getElementById("endereco").closest("label");
    const numeroCasaField = document.getElementById("numeroCasa").closest("label");
    const bairroField = document.getElementById("bairroSelect").closest("label");
    const formaPagamentoField = document.getElementById("formaPagamento").closest("label");
	const observacaoField = document.getElementById("observacao").closest("label");
    const trocoField = document.getElementById("labelTroco");

	nomeField.style.display = "block";
    whatsappField.style.display = "block";
    observacaoField.style.display = "block";
    mesaField.style.display = "none";
    enderecoField.style.display = "none";
    numeroCasaField.style.display = "none";
    bairroField.style.display = "none";
    formaPagamentoField.style.display = "none";
    trocoField.style.display = "none";


    if (tipo === "Delivery") {
        enderecoField.style.display = "block";
        numeroCasaField.style.display = "block";
        bairroField.style.display = "block";
        formaPagamentoField.style.display = "block";
        toggleTrocoField();
    } else if (tipo === "Retirada") {
        formaPagamentoField.style.display = "block";
        toggleTrocoField();
    } else if (tipo === "Mesa") {
        mesaField.style.display = "block";
    }

    atualizarTotalPedido();
}


    function mostrarPopupHorarios() {
      const lista = document.getElementById("listaHorariosFuncionamento");
      lista.innerHTML = "";
    
      if (!horarioFuncionamento) {
        lista.innerHTML = "<li>Hor√°rios n√£o dispon√≠veis.</li>";
      } else {
        for (const dia in horarioFuncionamento) {
          const h = horarioFuncionamento[dia];
          const li = document.createElement("li");
      
          if (!h.abertura || !h.fechamento) {
            li.innerHTML = `<strong>${dia}</strong><br>Fechado`;
          } else {
            let linhaHorario = `${h.abertura} √†s ${h.almocoInicio || h.fechamento}`;
            if (h.almocoInicio && h.almocoFim) {
              linhaHorario += ` e ${h.almocoFim} √†s ${h.fechamento}`;
            } else {
              linhaHorario = `${h.abertura} √†s ${h.fechamento}`;
            }
      
            li.innerHTML = `<strong>${dia}</strong><br>${linhaHorario}`;
          }
      
          li.style.marginBottom = "10px";
          lista.appendChild(li);
        }
      }

    
      document.getElementById("popupHorarios").classList.add("ativo");
    }
    
    function fecharPopupHorarios() {
      document.getElementById("popupHorarios").classList.remove("ativo");
    }
    
	
	document.getElementById("whatsappCliente").addEventListener("input", function (e) {
    let value = e.target.value.replace(/\D/g, "");

    if (value.length > 11) value = value.slice(0, 11);

    if (value.length >= 7) {
        e.target.value = value.replace(/^(\d{2})(\d{5})(\d{0,4})/, "$1 $2-$3");
    } else if (value.length >= 3) {
        e.target.value = value.replace(/^(\d{2})(\d{0,5})/, "$1 $2");
    } else {
        e.target.value = value;
    }
});

	
</script>

</body>
</html>







